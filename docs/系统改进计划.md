# 胃癌T分期诊断系统改进计划

## 一、当前系统评估

### 1.1 已实现功能
- ✅ 前端可视化界面（患者管理、图像查看、多种显示模式）
- ✅ 可解释性分析算法（法向梯度、双轨相关、曲率风险）
- ✅ 后端API服务
- ✅ 中英文国际化

### 1.2 核心问题
| 问题 | 描述 | 影响 |
|------|------|------|
| 算法准确性 | T1/T2误判率高 | 临床不可用 |
| 缺乏胃壁层次信息 | 只有肿瘤轮廓，无法判断浸润深度 | 无法区分T1-T4 |
| 单一特征 | 仅依赖边界梯度 | 特征不充分 |

---

## 二、改进方向

### 2.1 数据层面改进

#### A. 增加胃壁层次标注
```
当前标注: 只有肿瘤轮廓
需要增加:
  - 黏膜层边界
  - 黏膜下层边界  
  - 固有肌层边界
  - 浆膜层边界（关键！）
```

**实现方式**：
1. 请医生补充标注胃壁各层
2. 或使用半自动分割：先检测胃壁外轮廓，再细分各层

#### B. 收集更多临床信息
- 肿瘤位置（贲门/胃体/胃窦）
- 肿瘤大小（直径）
- 回声特征（低回声/等回声/高回声）
- 血流信号（Doppler）

### 2.2 算法层面改进

#### A. 多尺度特征提取

```python
# 当前: 只分析边界
features = analyze_boundary(contour)

# 改进: 多尺度分析
features = {
    'boundary': analyze_boundary(contour),           # 边界特征
    'tumor_region': analyze_tumor_texture(roi),      # 肿瘤纹理
    'peritumoral': analyze_peritumoral(ring),        # 瘤周特征
    'wall_layers': analyze_wall_layers(layers),      # 胃壁层次
    'morphology': analyze_shape(contour),            # 形态学特征
}
```

#### B. 深度学习辅助

**方案1：端到端分类**
```
输入: 超声图像 + 标注
输出: T分期 (T1/T2/T3/T4)
模型: ResNet/EfficientNet + Attention
```

**方案2：混合方法（推荐）**
```
1. 使用传统算法提取可解释特征
2. 使用轻量级网络提取深度特征
3. 融合两类特征进行分类
4. 保持可解释性的同时提高准确率
```

#### C. 基于规则的决策树

```python
def predict_t_stage(features):
    """
    基于临床规则的决策逻辑
    """
    # 规则1: 浆膜层是否被突破
    if features['serosal_breach']:
        return 'T4'
    
    # 规则2: 是否侵犯固有肌层外缘
    if features['muscle_layer_invasion'] == 'outer':
        return 'T3'
    
    # 规则3: 是否侵犯固有肌层
    if features['muscle_layer_invasion'] == 'inner':
        return 'T2'
    
    # 规则4: 局限于黏膜层
    return 'T1'
```

### 2.3 前端交互改进

#### A. 增加手动标注工具
让医生可以在前端直接标注胃壁层次，实时计算T分期

```
工具:
- 画笔工具（标注各层边界）
- 点标注（标记关键解剖点）
- 测量工具（测量浸润深度）
```

#### B. 分析结果对比
```
显示内容:
- AI预测 vs 医生判断
- 历史病例对比
- 相似病例检索
```

#### C. 报告生成
```
自动生成结构化报告:
- 肿瘤位置和大小
- 浸润深度评估
- T分期预测及依据
- 建议（是否需要进一步检查）
```

### 2.4 系统架构改进

#### A. 模型服务化
```
当前: 单一Python脚本
改进: 
  - 模型容器化 (Docker)
  - GPU推理支持
  - 批量处理能力
  - 模型版本管理
```

#### B. 数据管理
```
当前: 本地文件
改进:
  - 数据库存储 (PostgreSQL)
  - 图像存储 (MinIO/S3)
  - 标注管理系统
  - 数据版本控制
```

---

## 三、优先级排序

### 高优先级 (1-2周)
1. **修复当前算法的阈值问题**
   - 根据更多样本调整SII阈值
   - 添加肿瘤大小作为辅助特征

2. **增加肿瘤形态学特征**
   - 面积、周长、圆度
   - 长短轴比
   - 边界不规则度

3. **改进可视化**
   - 显示各层边界（如果有标注）
   - 显示浸润深度测量

### 中优先级 (1-2月)
4. **半自动胃壁分割**
   - 基于边缘检测的胃壁外轮廓检测
   - 层次结构分析

5. **混合特征模型**
   - 传统特征 + 深度特征融合
   - 保持可解释性

6. **前端标注工具**
   - 让医生可以修正AI预测
   - 收集反馈数据

### 低优先级 (长期)
7. **端到端深度学习模型**
8. **多模态融合**（超声 + CT + 病理）
9. **预后预测**（生存分析）

---

## 四、近期可执行任务

### 本周任务

1. **增加形态学特征到现有算法**
```python
def compute_morphology_features(contour):
    area = cv2.contourArea(contour)
    perimeter = cv2.arcLength(contour, True)
    circularity = 4 * np.pi * area / (perimeter ** 2)
    
    # 拟合椭圆
    ellipse = cv2.fitEllipse(contour)
    major_axis = max(ellipse[1])
    minor_axis = min(ellipse[1])
    aspect_ratio = major_axis / minor_axis
    
    return {
        'area': area,
        'perimeter': perimeter,
        'circularity': circularity,
        'aspect_ratio': aspect_ratio,
    }
```

2. **调整分期判断逻辑**
```python
# 结合肿瘤大小和边界特征
if tumor_area < small_threshold and sii > 0.3:
    return 'T1-T2'  # 小肿瘤，边界清晰
elif tumor_area > large_threshold and sii < 0.2:
    return 'T4'     # 大肿瘤，边界模糊
else:
    return 'T3'     # 中间情况
```

3. **前端显示更多信息**
   - 显示肿瘤面积（cm²）
   - 显示长短轴（cm）
   - 显示边界评分分布

---

## 五、技术债务清理

1. **代码重构**
   - 统一Python代码风格
   - 添加类型注解
   - 完善文档字符串

2. **测试覆盖**
   - 添加单元测试
   - 添加集成测试
   - CI/CD流程

3. **性能优化**
   - 图像加载优化
   - 算法计算优化
   - 前端渲染优化

---

## 六、研究方向

### 可发表的工作
1. **可解释性T分期系统**
   - 基于物理特征的方法
   - 与黑盒模型对比
   - 临床验证

2. **胃壁层次自动分割**
   - 半监督学习
   - 弱监督学习（只需粗略标注）

3. **多中心验证研究**
   - 算法泛化性
   - 不同设备、不同操作者

### 数据需求
- 更多标注样本（目标：每个T分期100+例）
- 病理金标准
- 随访数据（用于预后研究）

